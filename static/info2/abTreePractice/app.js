// Minified Javascript
// Original Code: https://github.com/aykamko/abTreePractice/blob/master/app.js
// Minified with: https://minify-js.com/
Array.prototype.extend=function(e){Array.prototype.push.apply(this,e)},angular.module("d3",[]).factory("d3Service",["$document","$q","$rootScope",function(e,t,n){var r=t.defer();function o(){n.$apply((function(){r.resolve(window.d3)}))}var i=e[0].createElement("script");return i.type="text/javascript",i.async=!0,i.src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js",i.onreadystatechange=function(){"complete"==this.readyState&&o()},i.onload=o,e[0].getElementsByTagName("body")[0].appendChild(i),{d3:function(){return r.promise}}}]),angular.module("Enums",[]).factory("EnumService",[function(){return{TreeNodeTypeEnum:{maxNode:"maxNode",minNode:"minNode",randNode:"randNode",leafNode:"leafNode",opposite:function(e){return e==this.maxNode?this.minNode:e==this.minNode?this.maxNode:e}}}}]),angular.module("ActionListQueue",[]).factory("ActionLQService",[function(){function e(e,t,n,r){this.object=e,this.key=t,this.oldVal=n,this.newVal=r}function t(){this.inAction=!1,this.lastAction=-1,this.actionListQueue=[],this.length=0}return e.prototype.apply=function(){this.object&&(this.object[this.key]=this.newVal)},e.prototype.reverse=function(){this.object&&(this.object[this.key]=this.oldVal)},t.prototype.pushActionList=function(e){return!this.inAction&&(this.actionListQueue.push(e),this.length+=1,!0)},t.prototype.extendActionList=function(e){return!this.inAction&&(this.actionListQueue.extend(e),this.length+=e.length,!0)},t.prototype.stepForward=function(){if(!this.inAction||this.lastAction==this.actionListQueue.length-1)return!1;this.lastAction+=1;for(var e=this.actionListQueue[this.lastAction],t=0;t<e.length;t++)e[t].apply();return!0},t.prototype.stepBackward=function(){if(!this.inAction||-1==this.lastAction)return!1;for(var e=this.actionListQueue[this.lastAction],t=0;t<e.length;t++)e[t].reverse();return this.lastAction-=1,!0},t.prototype.goToEnd=function(){if(this.inAction)for(;this.stepForward(););},t.prototype.goToBeginning=function(){if(this.inAction)for(;this.stepBackward(););},t.prototype.play=function(){if(this.inAction){var e=function(t){t.stepForward()&&setTimeout(e.bind(t))};e(this)}},t.prototype.pause=function(){clearTimeout(this.playTimeout)},{Action:e,ActionListQueue:t}}]),angular.module("Tree",["Enums","ActionListQueue"]).factory("TreeService",["EnumService","ActionLQService",function(e,t){var n=e.TreeNodeTypeEnum,r=t.Action,o=t.ActionListQueue;function i(e,t,n,r){this.rootNode=e,this.treeType=t,this.depth=n,this.branchingFactor=r,this.mutable=!0}function a(e,t,n,r){this.nodeType=e,this.setParent(t),this.depth=n,this.childNum=r,this.children=new Array(r),this.value=null}function u(e,t){this.source=e,this.target=t,this.pruned=!1}return i.generateABTreeRootNode=function(e,t,r,o,i){return function e(r,u,c,s){var l=new a(u,r,c,s);if(c==t)l.nodeType=n.leafNode,l.value=Math.round(Math.random()*(i-o))-i;else for(var d=0;d<s;d++)l.setKthChild(d,e(l,n.opposite(u),c+1,s));return l}(null,e,1,r)},i.prototype.alphaBeta=function(){var e=function(e,t){actions=[];var n=function(e,t,o){if(e){var i;e.edgeToParent&&(o.push(new r(e.edgeToParent,"pruned",!1,!0)),e.edgeToParent.__pruned=!0);for(var a=0;a<t;a++)i=e.getKthChild(a),n(i,t,o)}};return n(e,t,actions),actions},t=function(o,i,a,u,c,s){var l=[new r(o.edgeToParent,"entered",!1,!0),new r(o,"entered",!1,!0)],d=[];if(o.nodeType==n.leafNode)return{returnVal:o.value,enterActions:l,childActionsList:d,exitActions:[new r(o.edgeToParent,"entered",!0,!1)]};l.extend([new r(o,"alpha",o.alpha,a),new r(o,"beta",o.beta,u)]),o.__alpha=a,o.__beta=u;var h,p,f,g=0,v=!1,m=[],y=c?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;if(c)for(;g<i;g++)h=o.getKthChild(g),v?(m.extend(e(h,i)),m.push(new r(o,"pruned",!1,!0)),o.__pruned=!0):(p=[],(f=t(h,i,a,u,!c,s)).returnVal>y&&(y=f.returnVal,p.push(new r(o,"value",o.__value,y)),o.__value=y),f.returnVal>a&&(a=f.returnVal,p.extend([new r(o,"alpha",o.__alpha,a)]),o.__alpha=a),f.childActionsList.length?f.exitActions.extend(p):f.enterActions.extend(p),f.enterActions.extend(m),d.push(f.enterActions),d.extend(f.childActionsList),m=f.exitActions,u<=a&&(v=!0));else for(;g<i;g++)h=o.getKthChild(g),v?(m.extend(e(h,i)),m.push(new r(o,"pruned",!1,!0)),o.__pruned=!0):(p=[],(f=t(h,i,a,u,!c,s)).returnVal<y&&(y=f.returnVal,p.push(new r(o,"value",o.__value,y)),o.__value=y),f.returnVal<u&&(u=f.returnVal,p.extend([new r(o,"beta",o.__beta,u)]),o.__beta=u),f.childActionsList.length?f.exitActions.extend(p):f.enterActions.extend(p),f.enterActions.extend(m),d.push(f.enterActions),d.extend(f.childActionsList),m=f.exitActions,u<=a&&(v=!0));return d.push(m),{returnVal:y,enterActions:l,childActionsList:d,exitActions:[new r(o.edgeToParent,"entered",!0,!1),new r(o,"entered",!0,!1)]}},i=new o,a=t(this.rootNode,this.branchingFactor,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,this.treeType==n.maxNode);return i.pushActionList(a.enterActions),i.extendActionList(a.childActionsList),i.pushActionList(a.exitActions),i},i.prototype.checkAnswer=function(){return function e(t){if(t.nodeType==n.leafNode)return!0;if(t.value!=t.__value)return!1;if(t.edgeToParent&&t.edgeToParent.__pruned&&t.edgeToParent.__pruned!=t.edgeToParent.pruned)return!1;for(var r=!0,o=0;o<t.childNum;o++)r=r&&e(t.getKthChild(o));return r}(this.rootNode)},i.prototype.reset=function(){!function e(t){if(t.edgeToParent&&(t.edgeToParent.entered=!1,t.edgeToParent.pruned=!1),t.entered=!1,t.nodeType!=n.leafNode){t.value=null,t.alpha=null,t.beta=null;for(var r=0;r<t.childNum;r++)e(t.getKthChild(r))}}(this.rootNode)},i.prototype.setSolution=function(){this.alphaBeta(),function e(t){if(t.edgeToParent&&(t.edgeToParent.pruned=t.edgeToParent.__pruned),t.nodeType!=n.leafNode){t.value=t.__value,t.alpha=t.__alpha,t.beta=t.__beta,t.pruned=t.__pruned;for(var r=0;r<t.childNum;r++)e(t.getKthChild(r))}}(this.rootNode)},a.prototype.setKthChild=function(e,t){if(e>=this.childNum)throw"Error: node only holds "+e+" children.";this.children[e]=t},a.prototype.getKthChild=function(e){if(e>=this.childNum)throw"Error: node only holds "+e+" children.";return this.children[e]},a.prototype.setParent=function(e){e&&(this.edgeToParent=new u(e,this),this.parentNode=e)},{Tree:i,TreeNode:a,TreeEdge:u}}]),angular.module("abTreePractice",["d3","Enums","Tree"]).controller("MainCtrl",["EnumService","TreeService","$scope","$timeout",function(e,t,n,r){var o=e.TreeNodeTypeEnum,i=t.Tree;n.useAb=!0,n.setUseAb=function(e){n.useAb=e},n.maxVal=20,n.generateRootNode=function(e){n.tree.rootNode=i.generateABTreeRootNode(n.tree.treeType,n.tree.depth,n.tree.branchingFactor,-n.maxVal,n.maxVal),n.actionLQ=null},n.tree=new i(null,o.maxNode,4,3),n.generateRootNode(),n.incrBranchingFactor=function(e){n.tree.branchingFactor=Math.max(2,n.tree.branchingFactor+e),n.generateRootNode()},n.incrDepth=function(e){n.tree.depth=Math.max(3,n.tree.depth+e),n.generateRootNode()},n.flipMax=function(){n.tree.treeType=o.opposite(n.tree.treeType),n.generateRootNode()},n.checkAnswer=function(){n.actionLQ||(n.actionLQ=n.tree.alphaBeta()),n.correct=n.tree.checkAnswer()},n.correct=null,n.resetTree=function(){n.tree.reset(),n.reRender()},n.showSolution=function(){n.tree.setSolution(),n.reRender()},n.reRender=function(){},n.actionLQ=null,n.toggleABVisual=function(){if(n.actionLQ||(n.actionLQ=n.tree.alphaBeta()),n.resetTree(),n.actionLQ.inAction)return n.actionLQ.goToBeginning(),n.tree.mutable=!0,void(n.actionLQ.inAction=!1);n.tree.mutable=!1,n.actionLQ.inAction=!0,n.correct=null},n.stepBackward=function(){var e=!1;return n.actionLQ&&(e=n.actionLQ.stepBackward(),n.reRender()),e},n.stepForward=function(){var e=!1;return n.actionLQ&&(e=n.actionLQ.stepForward(),n.reRender()),e},n.goToBeginning=function(){n.actionLQ.goToBeginning(),n.reRender()},n.goToEnd=function(){n.actionLQ.goToEnd(),n.reRender()},n.timeStep=850,n.play=function(){var e=function(){n.stepForward()&&(n.playTimeout=r(e,n.timeStep))};e()},n.pause=function(){r.cancel(n.playTimeout)},n.slider=new Slider("input.slider",{reversed:!0,formatter:function(e){return e/1e3+"s per action"}}).on("slide",(function(e){n.timeStep=e}))}]).directive("abTree",["EnumService","d3Service","$window","$document",function(e,t,n,r){var o=e.TreeNodeTypeEnum;return{restrict:"E",scope:{tree:"=",reRender:"=",useAb:"="},link:function(e,i,a){angular.element(r).ready((function(){var a=80,u=Math.sqrt(Math.pow(a,2)-Math.pow(40,2)),c=Math.sqrt(Math.pow(a/Math.sqrt(3),2)-Math.pow(40,2));t.d3().then((function(t){var a=0,s=0,l=t.select(i[0]).append("svg");e.onResize=function(){var e=angular.element(r[0].getElementsByClassName("navbar"))[0].offsetHeight;a=n.innerWidth,s=n.innerHeight-e,l.attr("width",a).attr("height",s)},e.onResize();var d=-1;e.renderD3Tree=function(){e.nodes=[],e.links=[];var t=e.tree.rootNode,n=e.tree.branchingFactor,r=e.tree.depth,o=(s-200)/(r-1),i=function(e,t,r,a,u){if(e){var c=r-t,s=c/n,l=100+o*(e.depth-1),h=t+c/2;e.id=++d,e.x=h,e.y=l,a.push(e),e.edgeToParent&&u.push(e.edgeToParent);for(var p=0;p<n;p++){var f=e.getKthChild(p);i(f,t+s*p,t+s*(p+1),a,u)}}};i(t,100,a-100,e.nodes,e.links),e.reRender()},e.$watch((function(){return e.tree.rootNode}),e.renderD3Tree),e.$watch("useAb",(function(){e.reRender()})),angular.element(n).bind("resize",(function(){e.onResize(),clearTimeout(e.resizeTimeout),e.resizeTimeout=setTimeout((function(){e.renderD3Tree(),e.reRender()}),500)}));var h=l.append("svg:g").selectAll("path"),p=l.append("svg:g").selectAll("g"),f=null,g=null;function v(e,t){var n=(v.canvas||(v.canvas=r[0].createElement("canvas"))).getContext("2d");return n.font=t,n.measureText(e).width}e.reRender=function(){var n=(h=h.data(e.links,(function(e){return e.source.id+","+e.target.id}))).enter().append("svg:g");n.append("svg:path").attr("class","link"),n.append("svg:path").attr("class","mouselink").on("mousedown",(function(t){e.tree.mutable&&(t.pruned=!t.pruned,e.reRender())})).on("mouseover",(function(e){t.select(this.parentNode).select("path.link").classed("hover",!0)})).on("mouseout",(function(e){t.select(this.parentNode).select("path.link").classed("hover",!1)})),h.exit().remove(),h.select("path.link").attr("d",(function(e){return"M"+e.source.x+","+e.source.y+"L"+e.target.x+","+e.target.y})).classed("pruned",(function(e){return e.pruned})).classed("entered",(function(e){return e.entered})),h.select("path.mouselink").attr("d",(function(e){return"M"+e.source.x+","+e.source.y+"L"+e.target.x+","+e.target.y}));var r=(p=p.data(e.nodes,(function(e){return e.id}))).enter().append("svg:g").classed("node",!0).classed("leaf",(function(e){return e.nodeType==o.leafNode}));r.append("svg:path").classed("nodepath",!0).each((function(e){e.nodeEle=t.select(this.parentNode)})).attr("d",(function(e){if(e.nodeType==o.leafNode){var t=80/2.1,n=(80-t)/2;return"M"+n+","+-n+"L"+(t+n)+","+-n+"L"+(t+n)+","+(-t-n)+"L"+n+","+(-t-n)+"L"+n+","+-n}return"M0,0L80,0L40,"+-u+"L0,0"})).on("mousedown",(function(t){e.tree.mutable&&(g=t,t.oldVal=t.value,e.reRender())})),r.append("svg:text").attr("class","value"),r.append("svg:text").attr("class","prunemsg"),r.append("svg:text").attr("class","alpha"),r.append("svg:text").attr("class","beta"),p.exit().remove(),p.classed("entered",(function(e){return e.entered})).classed("pruned",(function(e){return e.pruned})),p.select("path.nodepath").attr("transform",(function(e){var t="",n="";return e.nodeType==o.leafNode?(t="translate("+(e.x-40)+","+(e.y+40)+")",n=""):e.nodeType==o.maxNode?t="translate("+(e.x-40)+","+(e.y+c)+")":e.nodeType==o.minNode&&(t="translate("+(e.x+40)+","+(e.y-c)+")",n=" rotate(180)"),t+n})),p.select("text.value").attr("x",(function(e){return e.x})).attr("y",(function(e){return e.y+6})).text((function(e){return null!=e.value?e.value:""})),p.select("text.alpha").attr("x",(function(e){return e.x+45})).attr("y",(function(e){return e.y-4})).text((function(t){var n;if(null!=t.alpha&&null!=t.beta)return e.useAb?"α: "+t.alpha.toString().replace("Infinity","∞"):(t.nodeType==o.maxNode?n="≥ "+t.beta.toString().replace("Infinity","∞"):t.nodeType==o.minNode&&(n="≤ "+t.alpha.toString().replace("Infinity","∞")),"c "+n)})),p.select("text.beta").attr("x",(function(e){return e.x+45})).attr("y",(function(e){return e.y+16})).text((function(t){if(null!=t.alpha&&null!=t.beta&&e.useAb)return"β: "+t.beta.toString().replace("Infinity","∞")})),p.select("rect.cursor").attr("x",(function(e){var n=e.value,r=null==n?"":n.toString(),o=t.select(this.parentNode).select("text").node(),i=o?o.getComputedTextLength():0,a=v(r.substring(0,m),"18px Helvetica Neue");return e.x+(a-i/2)})).attr("y",(function(e){return e.y-9}))};var m=null,y=null,T=null;function N(){m=Math.min(m+1,T.length)}function x(){m=Math.max(0,m-1)}function A(){var e=parseFloat(T);e=isNaN(e)?null:e,f.value=e,m=null,T=null,f=null,y.remove(),y=null}l.on("mousedown",(function(){if(f&&g!==f&&A(),g){if(g===f)return;f=g,g=null,nodeValue=f.value,T=null==nodeValue?"":nodeValue.toString(),m=T.length,y=f.nodeEle.append("svg:rect").attr("class","cursor").attr("height",16.5).attr("width",1.5).attr("opacity",1),function e(){y&&y.transition().duration(750).attr("opacity",0).transition().duration(750).attr("opacity",1).each("end",e)}(),e.reRender()}})),t.select(window).on("keydown",(function(){if(i=t.event.keyCode,f){var n=f.value;if(T=null==n?"":n.toString(),i>47&&i<58||189==i||190==i){var r=T.slice(0,m),o=T.slice(m,T.length),i=i>188?i-144:i,a=String.fromCharCode(i);T=r+a+o,f.value=T,N()}else if(8==i){t.event.preventDefault();r=T.slice(0,Math.max(0,m-1)),o=T.slice(m,T.length);T=r+o,f.value=T,x()}else 37==i?(t.event.preventDefault(),x()):39==i?(t.event.preventDefault(),N()):13==i?A():27==i&&(f.value=f.oldVal,m=null,T=null,f=null,y.remove(),y=null);e.reRender()}else;})).on("keyup",(function(){-1}))}))}))}}}]);